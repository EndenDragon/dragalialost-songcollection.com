(function(){!function(e){var t,n;return n=function(){function t(n){this.supportTLS11=!0,this.$el=e(n),this.$credit=this.$el.find("#credit-card"),this.$el.find("#gmo-credit").length>0&&(this.$credit=this.$el.find("#gmo-credit"),this.gmoShopID=this.$credit.find('[name$="[token_api_key]"]').val()),this.cards=[],this.$el.find('[name="creditcard[]"]').each(function(t){return function(n,i){return t.cards.push(e(i).val())}}(this)),this.$submit=this.$el.find("[type=submit]"),this.$submit.on("click",e.proxy(this.submitHandler,this)),this.$submit.prop("disabled",!1),window.execTran=function(e){t.prototype.execTranHandler(e)}}return t.VISA_REG=/^4[0-9]{12}(?:[0-9]{3})?$/,t.MASTER_REG=/^[5|2][0-9]{12}(?:[0-9]{3})?$/,t.prototype.execTranHandler=function(t){return"000"!==t.resultCode?(window.alert("処理に失敗しました"),location.reload()):(this.$credit=e("form").find("#gmo-credit"),this.$submit=e("form").find("[type=submit]"),this.$credit.find('[name$="[card_token]"]').val(t.tokenObject.token),this.$credit.find('[name$="[card_req_card_number]"]').val(t.tokenObject.maskedCardNo),this.$submit.submit())},t.prototype.submitHandler=function(){var e,t;return t=this.getTokenRequestData(),"100"===this.$el.find("[name=payment_type_id]:checked").val()?this.$credit.find('[name$="[security_code]"]').val().length<1||this.$credit.find('[name$="[card_number]"]').val().length<1?window.alert("フォームが空です"):(e=window.Multipayment,e.init(this.gmoShopID),e.getToken({cardno:this.$credit.find('[name$="[card_number]"]').val(),expire:[this.$credit.find('[name$="[card_expire2]"]').val().slice(-2),("00"+this.$credit.find('[name$="[card_expire1]"]').val()).slice(-2)].join(""),securitycode:this.$credit.find('[name$="[security_code]"]').val(),tokennumber:2},window.execTran),this.setCreditDisabled(!0)):"1"!==this.$el.find("[name=payment_type_id]:checked").val()||this.hasCardToken()?this.request():this.requestMdkToken(),!1},t.prototype.request=function(){return this.hideErrorMessages(),this.hasCardToken()&&this.setCreditDisabled(!0),e.ajax({url:this.$el.attr("action"),type:this.$el.attr("method"),data:this.$el.serialize(),dataType:"json",beforeSend:e.proxy(this.beforeSendHandler,this),success:e.proxy(this.successHandler,this),error:e.proxy(this.errorHandler,this),complete:e.proxy(this.completeHandler,this)})},t.prototype.beforeSendHandler=function(){return this.$submit.prop("disabled",!0)},t.prototype.successHandler=function(t){switch(t.status){case 200:return window.location=t.redirect_to;case 400:return this.$el.data("confirm")&&e.magnificPopup.close(),this.showErrorMessages(t.errors),this.setCreditDisabled(!1),this.$submit.prop("disabled",!1)}},t.prototype.errorHandler=function(e){return this.showErrorMessages(e.errors),this.$submit.prop("disabled",!1)},t.prototype.showErrorMessages=function(t){var n,i,o,r,s,a,l;l=[];for(o in t){switch(a=t[o],o=o.toLowerCase().replace(/(.*)::/,"")){case"credit":o="credit-card";break;case"cvs":o="convenience";break;default:o="payment"}i=this.$el.find("#"+o),n=e('<div class="alert alert-danger"></div>').appendTo(i),l.push(function(){var e;e=[];for(s in a)r=a[s],e.push(n.append("<div>"+r+"</div>"));return e}())}return l},t.prototype.hideErrorMessages=function(){return this.$el.find(".alert.alert-danger").remove()},t.prototype.setCreditDisabled=function(e){var t;return t='[name$="[card_number]"], [name$="[card_expire1]"], [name$="[card_expire2]"], [name$="[security_code]"], [name$="[token_api_key]"]',this.$el.find(t).prop("disabled",e)},t.prototype.requestMdkToken=function(){var t,n,i;return this.hideErrorMessages(),n=this.getTokenRequestData(),t={},this.validateTokenRequestData(n,t)?(i=this.supportTLS11?"https://api.veritrans.co.jp/4gtoken":"https://3gs.veritrans.co.jp/4gtoken",e.ajax({url:i,type:"POST",contentType:"application/json",data:JSON.stringify(n),dataType:"json",beforeSend:e.proxy(this.tokenBeforeSendHandler,this),success:e.proxy(this.tokenSuccessHandler,this),error:e.proxy(this.tokenErrorHandler,this)})):(this.$el.data("confirm")&&e.magnificPopup.close(),this.showErrorMessages(t))},t.prototype.tokenBeforeSendHandler=function(){return this.$submit.prop("disabled",!0)},t.prototype.tokenSuccessHandler=function(e){return this.setTokenResponseData(e),this.request()},t.prototype.hasCardToken=function(){return this.$credit.find('[name$="[card_token]"]').val()&&this.$credit.find('[name$="[card_req_card_number]"]').val()},t.prototype.tokenErrorHandler=function(e){var t,n;return 0===e.readyState&&0===e.status?(this.supportTLS11=!1,this.requestMdkToken()):(n=e.responseJSON.code,t={credit:{key:[e.responseJSON.message]}},this.showErrorMessages(t),this.$submit.prop("disabled",!1))},t.prototype.getTokenRequestData=function(){var e;return e={card_number:this.$credit.find('[name$="[card_number]"]').val(),card_expire:[("00"+this.$credit.find('[name$="[card_expire1]"]').val()).slice(-2),this.$credit.find('[name$="[card_expire2]"]').val().slice(-2)].join("/"),security_code:this.$credit.find('[name$="[security_code]"]').val(),token_api_key:this.$credit.find('[name$="[token_api_key]"]').val()}},t.prototype.setTokenResponseData=function(e){return this.$credit.find('[name$="[card_token]"]').val(e.token),this.$credit.find('[name$="[card_req_card_number]"]').val(e.req_card_number)},t.prototype.validateTokenRequestData=function(e,t){return e.card_number?this.cards.length>0&&!this.checkCardBrand(e.card_number)?(t.credit={card_number:["カード番号がご利用可能なクレジットカードの種類でない為ご利用いただけません"]},!1):this.$credit.data("expire")&&!this.checkCardExpire(e.card_expire)?(t.credit={card_expire:[this.$credit.data("expire-message")]},!1):e.security_code?!0:(t.credit={security_code:["セキュリティコードを入力してください"]},!1):(t.credit={card_number:["カード番号を入力してください"]},!1)},t.prototype.checkCardBrand=function(e){var n,i,o,r,s,a;for(o=!1,a=this.cards,r=0,s=a.length;s>r;r++)n=a[r],i=t[n.toUpperCase()+"_REG"],o||"undefined"==typeof i||(o=i.test(e));return o},t.prototype.checkCardExpire=function(e){var t,n,i;return i=e.split("/"),t=new Date(parseInt(String((new Date).getFullYear()).substr(0,2)+i[1]),parseInt(i[0]),0,23,59,59),n=new Date(this.$credit.data("expire")),t>n},t}(),t=function(t){return this.each(function(){var i,o,r;return i=e(this),o=i.data("select-payment-type-form"),r="object"==typeof t&&t,o||i.data("select-payment-type-form",o=new n(this,r)),i})},e.fn.selectPaymentTypeForm=t,e.fn.selectPaymentTypeForm.Constructor=n,window.SelectPaymentTypeForm=n,e(function(){return e(".select-payment-type-form").selectPaymentTypeForm()})}(window.$)}).call(this),function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};!function(e){var n,i;return n=function(n){function i(e){i.__super__.constructor.call(this,e)}return t(i,n),i.prototype.successHandler=function(t){var n,i;switch(t.status){case 200:return this.$el.data("finish-target-url")?window.location.href=this.$el.data("finish-target-url"):(i=this.$el.find("#finish-template"),"waiting"===t.order_status&&(i=this.$el.find("#finish-template-cvs")),n=e(i.html()).appendTo(this.$el),n.find("a").on("click",function(){return window.location.reload()}),n.modal());case 400:return this.$el.data("confirm")&&e.magnificPopup.close(),this.showErrorMessages(t.errors),this.setCreditDisabled(!1),this.$submit.prop("disabled",!1)}},i.prototype.errorHandler=function(){return this.$el.data("confirm")?e.magnificPopup.close():void 0},i.prototype.showErrorMessages=function(t){var n,o,r,s,a,l;i.__super__.showErrorMessages.call(this,t),l=[];for(r in t)a=t[r],o=this.$el.find("#error-container"),"digital_content_payment"===r?(n=e('<div class="alert alert-danger"></div>').appendTo(o),l.push(function(){var e,t,i;for(i=[],e=0,t=a.length;t>e;e++)s=a[e],i.push(n.append("<div>"+s+"</div>"));return i}())):l.push(void 0);return l},i}(SelectPaymentTypeForm),i=function(t){return this.each(function(){var i,o,r;return i=e(this),o=i.data("digital-content-select-payment-type-form"),r="object"==typeof t&&t,o||i.data("digital-content-select-payment-type-form",o=new n(this,r)),i})},e.fn.digitalContentSelectPaymentTypeForm=i,e.fn.digitalContentSelectPaymentTypeForm.Constructor=n,window.DigitalContentSelectPaymentTypeForm=n,e(function(){return e(".digital-content-select-payment-type-form").digitalContentSelectPaymentTypeForm()})}(window.$)}.call(this),function(){}.call(this);